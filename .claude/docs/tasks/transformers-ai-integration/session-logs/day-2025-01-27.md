# 2025-01-27 transformers.js AI 상담사 통합 세션

## Session metadata
- Start time: 22:00
- End time: 00:15
- Main work: transformers.js로 브라우저 내 AI 상담사 구현 (진행 중)
- Branch: main
- Owner: Claude

## Timeline

### [22:00] 작업 시작
- 사용자 요청: "webgpu를 사용하는 웹워커를 세팅해서 ai상담사가 답변을 달아주는걸 해보고 싶어"
- 제공된 코드: transformers.js, React Hook, Worker 예시 코드 참고
- 접근 방식: Web Worker + transformers.js (LaMini-Flan-T5-783M → flan-t5-small으로 변경)

### [22:15] 1차 구현 완료 (Worker 방식)
- 파일 생성:
  - `src/workers/modelWorker.js` (Worker)
  - `src/hooks/useModelInference.ts` (Hook)
  - `src/components/AIConsultant.tsx` (컴포넌트)
- 의존성 추가: `@xenova/transformers@2.17.2`
- 빌드 성공

### [22:30] 1차 에러 발생: HTML 응답
- **에러**: `SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON`
- **원인**: Vite dev server가 Hugging Face Hub 요청을 가로채서 HTML 반환
- **시도한 해결책**: Vite proxy 설정, worker 설정 변경

### [22:45] 2차 에러: onnxruntime-web 호환성
- **에러**: `Cannot read properties of undefined (reading 'registerBackend')`
- **원인**: Web Worker 환경에서 onnxruntime-web 초기화 실패
- **시도한 해결책**: env.backends 설정 변경

### [23:00] 3차 시도: Classic Worker + CDN
- **변경**: Worker를 public/worker.js로 이동, importScripts로 CDN 로드
- **에러**: CDN에서 transformers.js 로드 실패 (CORS/경로 문제)

### [23:15] 4차 시도: ES Module Worker
- **변경**: Worker를 src/workers/worker.ts로 복원, Vite worker 설정 추가
- **에러**: 여전히 같은 HTML 응답 에러

### [23:30] 5차 시도: 메인 스레드 실행
- **변경**: Worker 포기, 메인 스레드에서 직접 실행
- 파일 생성: `src/utils/modelInference.ts`, Hook 수정
- **에러**: 여전히 HTML 응답 에러

### [23:45] 프로젝트 구조 문제 발견
- **발견**: 원래 프로젝트는 루트 폴더에 존재 (App.tsx, components/, lib/)
- **문제**: 우리는 src/ 폴더에 새 프로젝트 생성
- **조치**: index.html 진입점 복원 (`/src/main.tsx` → `/index.tsx`)

### [00:00] 프리덕션 빌드 테스트
- **결과**: 빌드 성공, preview 서버 실행 (port 4173)
- **문제**: 여전히 모델 로딩 실패

### [23:45] 커밋 완료
- **커밋**: 38228a2 "feat: transformers.js AI 상담사 통합 시도"
- **변경 파일**: 15개 (1620 lines 추가, 40 lines 삭제)
- **상태**: Vite dev server 호환성 문제로 미완성

## Decision log

| Time | Decision | Reason | Alternative |
|------|----------|--------|-------------|
| 22:10 | flan-t5-small 모델 선택 | 더 가볍고 빠름 | LaMini-Flan-T5-783M (거부) |
| 22:20 | Web Worker 방식 채택 | 메인 스레드 차단 방지 | 메인 스레드 (나중에 변경) |
| 23:30 | 메인 스레드로 변경 | Worker 호환성 문제 | Worker 지속 시도 (실패) |
| 23:40 | Async handleSend | AI 생성은 비동기 작업 | Sync (불가능) |
| 23:40 | Fallback first | 사용자 경험 저하 방지 | Wait for model (나쁜 UX) |
| 23:55 | Fix worker path | `src/utils/` 기준 상대 경로 | 절대 경로 (Vite 미지원) |

## Issue log

### Issue #1: Vite dev server HTML 반환
- **발견**: 22:30
- **문제**: transformers.js가 Hugging Face Hub에서 파일을 가져올 때 Vite가 HTML 반환
- **원인**: Vite dev server가 외부 요청을 처리하지 못함
- **시도한 해결책**:
  1. proxy 설정 (/hf → huggingface.co) - 실패
  2. worker.plugins 빈 배열 - 실패
  3. optimizeDeps.exclude - 실패
  4. fs.strict: false - 실패
- **현재 상태**: 프리덕션 빌드에서도 동일 문제
- **소요 시간**: 90분+
- **다음 단계**: 서버 측 프록시 또는 다른 접근 방식 고려

### Issue #2: onnxruntime-web Worker 호환성
- **발견**: 22:45
- **문제**: Web Worker에서 registerBackend undefined
- **원인**: onnxruntime-web이 Worker 환경을 지원하지 않거나 Vite 번들링과 호환성 문제
- **해결**: 메인 스레드 실행으로 변경
- **소요 시간**: 45분

### Issue #3: 프로젝트 구조 혼란
- **발견**: 23:45
- **문제**: 원래 프로젝트 (루트) vs 새 프로젝트 (src/) 혼재
- **해결**: 진입점 복원, 원래 프로젝트 사용
- **소요 시간**: 15분

### Issue #4: Worker module loading error
- **발견**: 23:55
- **문제**: `new URL('./workers/worker.ts', import.meta.url)`가 잘못된 경로 가리킴
- **원인**: `src/utils/modelInference.ts`에서 `./workers/`는 `src/utils/workers/`를 가리킴
- **해결**: 경로를 `../workers/worker.ts`로 수정 (`src/workers/worker.ts`를 가리키도록)
- **소요 시간**: 5분
- **예방**: Vite 프로젝트에서 상대 경로 사용 시 기준 파일 위치 명확히 확인

## Blocking/Waiting

| Start | End | Reason | Impact |
|-------|-----|--------|--------|
| 22:30 | 진행 중 | Vite dev server 외부 요청 처리 | 작업 중단 |

## Retrospective notes

### What went well
- 빌드 시스템은 정상 작동
- 다양한 접근 방식 시도

### What to improve
- Vite dev server와 transformers.js 호환성 사전 조사 필요
- Web Worker 환경에서의 외부 요청 처리 방식 연구 필요

### Lessons learned
- transformers.js는 Hugging Face Hub에서 직접 파일을 가져옴
- Vite dev server가 이 요청을 가로채서 HTML을 반환함
- 프리덕션 빌드에서도 동일한 문제가 발생하여 근본적인 해결책 필요

---

## [23:30] 재개: ChatDetail.tsx 통합

### [23:30] 계획 확인
- 이전 작업: Web Worker 인프라 구축 완료
- 새 작업: ChatDetail.tsx에 useModelInference 훅 통합
- 참고: 계획서 확인

### [23:35] Phase 1: useModelInference 통합
- ChatDetail.tsx에 `useModelInference` 훅 import 추가
- AI 상태 (`status`, `progress`, `error`, `generate`) 사용 가능
- Import 경로: `@/src/hooks/useModelInference`

### [23:40] Phase 2: handleSend() 수정
- `aiStatus === 'ready'` 시 Web Worker AI 먼저 시도
- 실패 시 `getSmartResponse()` 폴백
- 모델 로딩 중이면 바로 폴백 사용
- 비동기 처리로 변경 (`async/await`)

### [23:45] Phase 3: AI 상태 UI 추가
- `loading`: 파란색 배경, "AI 모델 로딩 중... X%"
- `ready`: 초록색 배경, "AI 준비 완료"
- `error`: 주황색 배경, 에러 메시지 + 폴백 모드 안내
- `generating`: 보라색 배경, "AI 답변 생성 중..."

### [23:50] Build 성공
- 빌드 완료 확인
- ChatDetail 번들: 32.14 kB

### [23:55] Issue #4: Worker module loading error
- **문제**: "Failed to load module script: The server responded with a non-JavaScript MIME type"
- **원인**: 워커 경로가 `./workers/worker.ts`로 설정되어 있었으나, 실제 파일은 `src/workers/worker.ts`에 위치
- **해결**: `src/utils/modelInference.ts`에서 경로를 `../workers/worker.ts`로 수정
- **소요 시간**: 5분

### [00:00] Phase 4: 디버깅 로그 추가
- `worker.ts`: `[Worker]` - 메시지 수신, 초기화, 생성, 결과, 에러
- `modelInference.ts`: `[WorkerManager]` - 워커 생성, 상태, 진행률, 요청/응답
- `useModelInference.ts`: `[useModelInference]` - 초기화, 진행률, 생성
- `ChatDetail.tsx`: `[ChatDetail]` - AI 상태, 폴백 선택, 응답

## Changed files (Phase 2: Integration)

| File | 변경 내용 |
|------|----------|
| `components/customer/ChatDetail.tsx` | useModelInference import, handleSend 비동기화, AI 상태 UI 추가, 디버깅 로그 |
| `src/utils/modelInference.ts` | 워커 경로 수정, 디버깅 로그 추가 |
| `src/hooks/useModelInference.ts` | 디버깅 로그 추가 |
| `src/workers/worker.ts` | 디버깅 로그 추가 |

## Verification (Phase 2)

- [x] Build 성공 (`npm run build`)
- [ ] 개발 서버 테스트 (http://localhost:3000)
- [ ] AI 모델 로딩 확인
- [ ] 메시지 전송 및 AI 응답 확인
- [ ] 폴백 동작 확인

## Next steps

1. 브라우저에서 실제 동작 테스트
2. AI 모델 다운로드/로딩 과정 확인
3. 생성된 응답 품질 확인
4. 필요시 프롬프트 엔지니어링

---

## [00:15] 커밋 완료

- **커밋**: 21c2750 "feat: ChatDetail에 Web Worker AI 통합 및 디버깅 로그 추가"
- **변경 파일**: 5개 (525 lines 추가, 91 lines 삭제)
- **주요 변경**:
  - ChatDetail.tsx: useModelInference 훅 통합, handleSend 비동기화, AI 상태 UI
  - modelInference.ts: 워커 경로 수정, 디버깅 로그
  - useModelInference.ts, worker.ts: 디버깅 로그
  - session-log 업데이트
